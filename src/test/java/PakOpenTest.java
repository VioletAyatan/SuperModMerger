import ankol.mod.merger.antlr.scr.TechlandScriptLexer;
import ankol.mod.merger.antlr.scr.TechlandScriptParser;
import ankol.mod.merger.merger.scr.TechlandScrFileVisitor;
import ankol.mod.merger.merger.scr.node.ScrContainerScriptNode;
import ankol.mod.merger.tools.JacksonUtil;
import ankol.mod.merger.tools.Tools;
import cn.hutool.core.io.FileUtil;
import cn.hutool.core.util.StrUtil;
import org.antlr.v4.runtime.CharStream;
import org.antlr.v4.runtime.CharStreams;
import org.antlr.v4.runtime.CommonTokenStream;
import org.apache.commons.compress.archivers.zip.ZipArchiveEntry;
import org.apache.commons.compress.archivers.zip.ZipFile;
import org.junit.Test;
import tool.TestTool;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Enumeration;

public class PakOpenTest {
    private final String[] scrFileSuffix = new String[]{".scr", ".def", ".loot", ".phx", ".ppfx", ".ares", ".mpcloth"};

    /**
     * 遍历Techlandpak包测试
     */
    @Test
    public void test() {
        StringBuilder dltbPath = TestTool.getDltbPath();
        if (dltbPath == null) return;
        String pakFilePath = dltbPath.append(StrUtil.join(File.separator, "", "ph_ft", "source", "data0.pak")).toString();
        System.out.println("pakFilePath = " + pakFilePath);
        long count = 0;
        try (ZipFile zipFile = ZipFile.builder().setFile(pakFilePath).get()) {
            Enumeration<ZipArchiveEntry> entries = zipFile.getEntries();
            while (entries.hasMoreElements()) {
                count++;
                ZipArchiveEntry zipEntry = entries.nextElement();
                String entryName = zipEntry.getName();
                try {
                    if (StrUtil.endWithAny(entryName, scrFileSuffix)) {
                        System.out.println("zipEntry = " + entryName);
                        if (zipEntry.getSize() == 0) {
                            System.err.println("文件为空，跳过处理：" + entryName);
                        } else {
                            TechlandScriptParser parser = getParser(zipFile.getInputStream(zipEntry));
                            parser.removeErrorListeners();
                            parser.file();
                        }
                    } else {
                        System.err.println("不支持的类型，跳过处理：" + entryName);
                    }
                } catch (IOException e) {
                    System.err.println("文件：" + entryName + "处理失败，跳过！" + e.getMessage());
                }
            }
            System.out.println("遍历完成，总文件数：" + count + "个");
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    @Test
    public void test2() {
        StringBuilder dltbPath = TestTool.getDltbPath();
        if (dltbPath == null) return;
        String pakFilePath = dltbPath.append(StrUtil.join(File.separator, "", "ph_ft", "source", "data0.pak")).toString();
        System.out.println("pakFilePath = " + pakFilePath);
        long count = 0;
        try (ZipFile zipFile = ZipFile.builder().setFile(new File(pakFilePath)).get()) {
            Enumeration<ZipArchiveEntry> entries = zipFile.getEntries();
            while (entries.hasMoreElements()) {
                count++;
                ZipArchiveEntry zipEntry = entries.nextElement();
                String entryName = zipEntry.getName();
                try {
                    if (StrUtil.endWithAny(entryName, scrFileSuffix)) {
                        ScrContainerScriptNode parser = visitorParse(zipFile.getInputStream(zipEntry));
                        System.out.println("parser = " + parser);
                    } else {
                        System.err.println("不支持的类型，跳过处理：" + entryName);
                    }
                } catch (IOException e) {
                    System.err.println("文件：" + entryName + "处理失败，跳过！" + e.getMessage());
                }
            }
            System.out.println("遍历完成，总文件数：" + count + "个");
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    @Test
    public void test3() {
        try {
            String string = Files.readString(Path.of(Tools.getUserDir() + "/examples/sync_actions_finishers.def"));
            ScrContainerScriptNode scriptNode = visitorParse(string);
            JacksonUtil.toJson(scriptNode, FileUtil.getOutputStream(Tools.getUserDir() + "/test1.json"));
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }


    private TechlandScriptParser getParser(InputStream code) throws IOException {
        var input = org.antlr.v4.runtime.CharStreams.fromStream(code);
        var lexer = new TechlandScriptLexer(input);
        var tokens = new org.antlr.v4.runtime.CommonTokenStream(lexer);
        return new TechlandScriptParser(tokens);
    }

    private static ScrContainerScriptNode visitorParse(InputStream content) throws IOException {
        CharStream input = CharStreams.fromStream(content);
        TechlandScriptLexer lexer = new TechlandScriptLexer(input);
        CommonTokenStream tokens = new CommonTokenStream(lexer);
        TechlandScriptParser parser = new TechlandScriptParser(tokens);
        TechlandScrFileVisitor visitor = new TechlandScrFileVisitor();
        // 注意：visitFile 返回的一定是我们定义的 ROOT Container
        return (ScrContainerScriptNode) visitor.visitFile(parser.file());
    }

    private static ScrContainerScriptNode visitorParse(String content) throws IOException {
        CharStream input = CharStreams.fromString(content);
        TechlandScriptLexer lexer = new TechlandScriptLexer(input);
        CommonTokenStream tokens = new CommonTokenStream(lexer);
        TechlandScriptParser parser = new TechlandScriptParser(tokens);
        TechlandScrFileVisitor visitor = new TechlandScrFileVisitor();
        // 注意：visitFile 返回的一定是我们定义的 ROOT Container
        return (ScrContainerScriptNode) visitor.visitFile(parser.file());
    }
}
